/*!
 *
 * Core framework-independent engine to manipulate with SVG maps.
 * Supports touch devices, scaling, dragging, inner shadows, VML in case of IE,
 * etc.
 *
 * Copyright 2012, SmartTeleMax Ltd.
 * Licensed under the MIT license.
 *
 *
 * Based on jVectorMap version 0.1a
 *
 * Copyright 2011, Kirill Lebedev
 * Licensed under the MIT license.
 *
 */
!function(){var t={backgroundColor:"#505050",color:"#ffffff",scaleColors:["#b6d6ff","#005ace"],normalizeFunction:"linear"};function e(t){for(var e=1;e<arguments.length;e++)for(key in arguments[e])t[key]=arguments[e][key];return t}function i(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)}function s(t){t.preventDefault?t.preventDefault():t.returnValue=!1}function o(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0}function a(t){return t.pageX||t.pageY?{pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY}:{pageX:t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,pageY:t.clientY+document.body.scrollTop+document.documentElement.scrollTop,clientX:t.clientX,clientY:t.clientY}}window.vectorMap=function(i,s){var o=e({},t,s);return o.container=i,new r(o)};var n=function(t,e){if(this.mode=window.SVGAngle?"svg":"vml","svg"==this.mode)this.createSvgNode=function(t){return document.createElementNS(this.svgns,t)};else{try{document.namespaces.rvml||document.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),this.createVmlNode=function(t){return document.createElement("<rvml:"+t+' class="rvml">')}}catch(t){this.createVmlNode=function(t){return document.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}document.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)")}"svg"==this.mode?this.canvas=this.createSvgNode("svg"):(this.canvas=this.createVmlNode("group"),this.canvas.style.position="absolute"),this.setSize(t,e)};n.prototype={svgns:"http://www.w3.org/2000/svg",mode:"svg",width:0,height:0,canvas:null,setSize:function(t,e){if("svg"==this.mode)this.canvas.setAttribute("width",t),this.canvas.setAttribute("height",e);else if(this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.canvas.coordsize=t+" "+e,this.canvas.coordorigin="0 0",this.rootGroup){for(var i=this.rootGroup.getElementsByTagName("shape"),s=0,o=i.length;s<o;s++)i[s].coordsize=t+" "+e,i[s].style.width=t+"px",i[s].style.height=e+"px";this.rootGroup.coordsize=t+" "+e,this.rootGroup.style.width=t+"px",this.rootGroup.style.height=e+"px"}this.width=t,this.height=e},createPath:function(t){var e;if("svg"==this.mode)(e=this.createSvgNode("path")).setAttribute("d",t.path),e.setFill=function(t){return t?this.setAttribute("fill",t):this.removeAttributeNS(null,"fill"),this},e.setStroke=function(t,e){return null!=t&&this.setAttribute("stroke",t),null!=e&&(/^\d+$/.test(e+"")&&(e+="px"),this.setAttribute("stroke-width",e)),this},e.getFill=function(t){return this.style.getProperty("fill")},e.setOpacity=function(t){return null!=t&&this.setAttribute("fill-opacity",t),this};else{(e=this.createVmlNode("shape")).coordorigin="0 0",e.coordsize=this.width+" "+this.height,e.style.width=this.width+"px",e.style.height=this.height+"px",e.fillcolor="#ddd",e.stroked=!0,e.path=this.pathSvgToVml(t.path);var i=this.createVmlNode("skew");i.on=!0,i.matrix="0.01,0,0,0.01,0,0",i.offset="0,0",e.appendChild(i);var s=this.createVmlNode("stroke");s.weight=0,e.appendChild(s);var o=this.createVmlNode("fill");o.chromakey="#FFF",e.appendChild(o),e.setStroke=function(t,e){var i=this.getElementsByTagName("stroke")[0];return null!=t&&(i.color=t),null!=e&&(i.weight=e/3),this},e.setFill=function(t){return this.getElementsByTagName("fill")[0].color=t,this},e.getFill=function(t){return this.getElementsByTagName("fill")[0].color},e.setOpacity=function(t){return this.getElementsByTagName("fill")[0].opacity=parseInt(100*t)+"%",this}}return e},createGroup:function(t){var e;return"svg"==this.mode?e=this.createSvgNode("g"):((e=this.createVmlNode("group")).style.width=this.width+"px",e.style.height=this.height+"px",e.style.left="0px",e.style.top="0px",e.coordorigin="0 0",e.coordsize=this.width+" "+this.height),t&&(this.rootGroup=e),e},applyTransformParams:function(t,e,i){"svg"==this.mode?this.rootGroup.setAttribute("transform","scale("+t+") translate("+e+", "+i+")"):(this.rootGroup.coordorigin=this.width-e+","+(this.height-i),this.rootGroup.coordsize=this.width/t+","+this.height/t)},pathSvgToVml:function(t){t=t.split(" ");var e,i=0,s=0,o=[],a=0,n=0,r=[],h=null;function l(t,e,i){null===h&&(h={x:e,y:i}),o.push(t+e+","+i)}for(;n<t.length;)if("z"==t[n]&&h)l("l",h.x,h.y),h=null;else if(1==t[n].length&&-1!="MCLHVmclhvz".indexOf(t[n]))e=t[n],n++;else{function c(){var e;return a<r.length?(e=r[a],a+=1):(e=(r=t[n].split(","))[0],n+=1,a=1),Math.round(100*parseFloat(e))}switch(e){case"m":l("m",i+=c(),s+=c()),e="l";break;case"M":l("m",i=c(),s=c()),e="L";break;case"l":l("l",i+=c(),s+=c());break;case"L":l("l",i=c(),s=c());break;case"h":l("l",i+=c(),s);break;case"H":l("l",i=c(),s);break;case"v":l("l",i,s+=c());break;case"V":l("l",i,s=c());break;case"c":c(),c(),c(),c(),l("l",i+=c(),s+=c());break;case"C":c(),c(),c(),c(),l("l",i=c(),s=c())}}return o.join(" ")}};var r=function(t){t=t||{};var e=this;for(var i in this.container=t.container,this.defaultWidth=t.svg_width,this.defaultHeight=t.svg_height,"maxScale"in t&&(this.maxScale=t.maxScale),"minScale"in t&&(this.minScale=t.minScale),this.doubletouchEnabled=t.doubletouchEnabled||!1,this.color=t.color,this.stroke=t.stroke,this.label_locked=!1,this.width=this.containerWidth(),this.height=this.containerHeight(),this.resize(),this.do_resize=function(){e.width=t.container.clientWidth,e.height=t.container.clientHeight,e.resize(),e.canvas.setSize(e.width,e.height),e.applyTransform()},this.canvas=new n(this.width,this.height),t.container.appendChild(this.canvas.canvas),this.rootGroup=this.canvas.createGroup(!0),this.index=r.mapIndex,t.paths){var s=this.canvas.createPath({path:t.paths[i]});s.setFill(this.color),this.stroke&&s.setStroke(this.stroke[0],this.stroke[1]),"opacity"in t&&s.setOpacity(t.opacity),s.id="vectormap"+e.index+"_"+i,e.countries[i]=s,this.rootGroup.appendChild(s)}this.setColors(t.colors),this.canvas.canvas.appendChild(this.rootGroup),this.applyTransform(),"onTransform"in t&&(this.onTransform=t.onTransform),this.colorScale=new h(t.scaleColors,t.normalizeFunction,t.valueMin,t.valueMax),t.values&&(this.values=t.values,this.setValues(t.values)),r.mapIndex++};window.WorldMap=r,r.prototype={transX:0,transY:0,scale:1,baseTransX:0,baseTransY:0,baseScale:1,maxScale:1e3,minScale:null,doubletouchEnabled:!1,width:0,height:0,countries:{},countriesColors:{},countriesData:{},zoomStep:1.4,zoomMaxStep:4,zoomCurStep:1,hasTouch:"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,onTransform:function(){},setColors:function(t,e){if("string"==typeof t)this.countries[t].setFill(e);else{var i=t;for(var s in i)this.countries[s]&&this.countries[s].setFill(i[s])}},setValues:function(t){var e,i=0,s=Number.MAX_VALUE;for(var o in t)(e=parseFloat(t[o]))>i&&(i=t[o]),e&&e<s&&(s=e);this.colorScale.setMin(s),this.colorScale.setMax(i);var a={};for(o in t)e=parseFloat(t[o]),a[o]=e?this.colorScale.getColor(e):this.color;this.setColors(a),this.values=t},setScaleColors:function(t){this.colorScale.setColors(t),this.values&&this.setValues(this.values)},setNormalizeFunction:function(t){this.colorScale.setNormalizeFunction(t),this.values&&this.setValues(this.values)},resize:function(){var t=this.baseScale;this.width/this.height>this.defaultWidth/this.defaultHeight?(this.baseScale=this.height/this.defaultHeight,this.baseTransX=Math.abs(this.width-this.defaultWidth*this.baseScale)/(2*this.baseScale)):(this.baseScale=this.width/this.defaultWidth,this.baseTransY=Math.abs(this.height-this.defaultHeight*this.baseScale)/(2*this.baseScale)),this.scale*=this.baseScale/t,this.transX*=this.baseScale/t,this.transY*=this.baseScale/t},applyTransform:function(t,e){void 0!==t&&(this.transX=t),void 0!==e&&(this.transY=e),this.transX=Math.max(this.transX,this.width/this.scale-this.defaultWidth),this.transX=Math.min(this.transX,0),this.transY=Math.max(this.transY,this.height/this.scale-this.defaultHeight),this.transY=Math.min(this.transY,0),this.canvas.applyTransformParams(this.scale,this.transX,this.transY),this.onTransform()},fitToPath:function(t){var e=t.getBBox(),i=Math.min(this.width/(1.2*e.width),this.height/(1.2*e.height));this.scale=this.correctScale(i),this.transX=-e.x+(this.width/this.scale-e.width)/2,this.transY=-e.y+(this.height/this.scale-e.height)/2,this.applyTransform()},setScale:function(t){this.scale=this.correctScale(t),this.applyTransform()},getPath:function(t){return document.getElementById("vectormap"+this.index+"_"+t)},getMaxScale:function(){var t=this.maxScale;return"string"==typeof t&&"x"==t.charAt(0)&&(t=this.baseScale*t.substr(1)),t},getMinScale:function(){var t=null!==this.minScale?this.minScale:this.baseScale;return"string"==typeof t&&"x"==t.charAt(0)&&(t=this.baseScale*t.substr(1)),t},correctScale:function(t){return Math.min(Math.max(t,this.getMinScale()),this.getMaxScale())},makeDraggable:function(){this.draggable||(this.draggable=!0,this.hasTouch?this.makeDraggableByTouch():this.makeDraggableByMouse())},makeDraggableByMouse:function(){var t,e=!1,n=this;function r(t){s(t),o(t);var e=t.wheelDelta||-t.detail,i=n.scale;e<0?i*=.9:e>0&&(i/=.9),i=n.correctScale(i);var r=1/n.scale-1/i,h=a(t),l=n.containerPosition();n.transX-=r*(h.pageX-l.x),n.transY-=r*(h.pageY-l.y),n.scale=i,n.applyTransform()}n.dragged=!1,i(document,"mousemove",(function(i){if(e){var s=n.transX+(i.clientX-t.x)/n.scale,o=n.transY+(i.clientY-t.y)/n.scale;n.applyTransform(s,o),t={x:i.clientX,y:i.clientY},n.dragged=!0}})),i(document,"mouseup",(function(){e=!1})),i(this.container,"mousedown",(function(i){e=!0,n.dragged=!1,t={x:i.clientX,y:i.clientY}})),i(this.container,"DOMMouseScroll",r),i(this.container,"mousewheel",r)},makeDraggableByTouch:function(){var t=null,e=null,a=null,n=this;n.dragged=!1,i(this.container,"touchmove",(function(i){if(n.dragged=!0,n.doubletouchEnabled&&i.touches&&2==i.touches.length){s(i),o(i);var r=i.touches.item(0),h=i.touches.item(1),l=Math.sqrt(Math.pow(r.clientX-h.clientX,2)+Math.pow(r.clientY-h.clientY,2)),c=n.containerPosition(),u={x:(r.pageX+h.pageX)/2-c.x,y:(r.pageY+h.pageY)/2-c.y};if(t){var d=n.scale,f=n.scale*l/t;f=n.correctScale(f);d=.5*(1/n.scale-1/f);var g=u.x*d,m=u.y*d;n.transX+=(u.x-e.x-g)/f,n.transY+=(u.y-e.y-m)/f,n.scale=f,n.applyTransform()}t=l,e=u}else if(i.touches&&1==i.touches.length){if(n.scale>n.baseScale){s(i),o(i),t=e=null;var p={x:i.touches.item(0).clientX,y:i.touches.item(0).clientY};a&&(n.transX+=(p.x-a.x)/n.scale,n.transY+=(p.y-a.y)/n.scale,n.applyTransform()),a=p}}else t=e=a=null})),i(this.container,"touchstart",(function(){t=e=a=null,n.dragged=!1})),i(this.container,"touchend",(function(){t=e=a=null}))},addBubble:function(t,e){var s=this,o=e.paths||this.rootGroup.getElementsByTagName("svg"==this.canvas.mode?"path":"shape");if(this.hasTouch){var n=null;for(r=o.length;r--;){i(h=o[r],"touchstart",(function(t){var e=t.touches;1==e.length&&(this.mouseCoords={pageX:e.item(0).pageX,pageY:e.item(0).pageY,clientX:e.item(0).clientX,clientY:e.item(0).clientY})})),i(h,"touchend",(function(t){s.dragged||(n==this||e.clickOnTouch?e.click.call(this,t,this.mouseCoords):(e.mouseover.call(this,this.mouseCoords),e.mousemove.call(this,this.mouseCoords)),n=this)}))}t&&(i(t,"touchmove",(function(t){this.style.display="none",n=!1})),i(t,"touchend",(function(t){this.style.display="none",e.click.call(this,t,this.mouseCoords)})))}else{for(var r=o.length;r--;){var h;i(h=o[r],"mousemove",(function(t){var i=t.target||t.srcElement;e.mousemove.call(i,a(t))})),i(h,"mouseover",(function(t){var i=t.target||t.srcElement;e.mouseover.call(i,a(t)),e.mousemove.call(i,a(t))})),"svg"!=this.canvas.mode?i(h,"mouseup",(function(t){s.dragged||e.click.call(t.target||t.srcElement,t,a(t))})):i(h,"click",(function(t){s.dragged||e.click.call(this,t,a(t))})),i(h,"mouseout",e.unhover)}t&&i(t,"mousemove",(function(t){var e=t.target||t.srcElement,i=a(t);e.style.left=i.pageX+5+"px"}))}},addShadowStyle:function(t,e,i,s){var o=this.canvas;if("svg"==o.mode){var a,n=o.createSvgNode("defs"),r=o.createSvgNode("filter");r.setAttribute("id","inner-shadow-"+this.index),n.appendChild(r),(a=o.createSvgNode("feOffset")).setAttribute("dx",e),a.setAttribute("dy",i),r.appendChild(a),(a=o.createSvgNode("feGaussianBlur")).setAttribute("stdDeviation",s),a.setAttribute("result","offset-blur"),r.appendChild(a),(a=o.createSvgNode("feComposite")).setAttribute("operator","out"),a.setAttribute("in","SourceGraphic"),a.setAttribute("in2","offset-blur"),a.setAttribute("result","inverse"),r.appendChild(a),(a=o.createSvgNode("feFlood")).setAttribute("flood-color",t),a.setAttribute("flood-opacity","0.75"),a.setAttribute("result","color"),r.appendChild(a),(a=o.createSvgNode("feComposite")).setAttribute("operator","in"),a.setAttribute("in","color"),a.setAttribute("in2","inverse"),a.setAttribute("result","shadow"),r.appendChild(a),(a=o.createSvgNode("feComposite")).setAttribute("operator","over"),a.setAttribute("in","shadow"),a.setAttribute("in2","SourceGraphic"),r.appendChild(a),o.canvas.insertBefore(n,this.rootGroup)}}},r.mapIndex=1,"undefined"!=typeof MooTools?e(r.prototype,{containerPosition:function(){return this.container.getPosition()},containerWidth:function(){return this.container.getWidth()},containerHeight:function(){return this.container.getHeight()}}):"undefined"!=typeof jQuery&&e(r.prototype,{containerPosition:function(){var t=jQuery(this.container).offset();return{x:t.left,y:t.top}},containerWidth:function(){return jQuery(this.container).width()},containerHeight:function(){return jQuery(this.container).height()}});var h=function(t,e,i,s){t&&this.setColors(t),e&&this.setNormalizeFunction(e),i&&this.setMin(i),i&&this.setMax(s)};h.prototype={colors:[],setMin:function(t){this.clearMinValue=t,"function"==typeof this.normalize?this.minValue=this.normalize(t):this.minValue=t},setMax:function(t){this.clearMaxValue=t,"function"==typeof this.normalize?this.maxValue=this.normalize(t):this.maxValue=t},setColors:function(t){for(var e=0;e<t.length;e++)t[e]=h.rgbToArray(t[e]);this.colors=t},setNormalizeFunction:function(t){"polynomial"===t?this.normalize=function(t){return Math.pow(t,.2)}:"linear"===t?delete this.normalize:this.normalize=t,this.setMin(this.clearMinValue),this.setMax(this.clearMaxValue)},getColor:function(t){"function"==typeof this.normalize&&(t=this.normalize(t));for(var e,i=[],s=0,o=0;o<this.colors.length-1;o++)e=this.vectorLength(this.vectorSubtract(this.colors[o+1],this.colors[o])),i.push(e),s+=e;var a,n=(this.maxValue-this.minValue)/s;for(o=0;o<i.length;o++)i[o]*=n;for(o=0,t-=this.minValue;t-i[o]>=0;)t-=i[o],o++;for(a=o==this.colors.length-1?this.vectorToNum(this.colors[o]).toString(16):this.vectorToNum(this.vectorAdd(this.colors[o],this.vectorMult(this.vectorSubtract(this.colors[o+1],this.colors[o]),t/i[o]))).toString(16);a.length<6;)a="0"+a;return"#"+a},vectorToNum:function(t){for(var e=0,i=0;i<t.length;i++)e+=Math.round(t[i])*Math.pow(256,t.length-i-1);return e},vectorSubtract:function(t,e){for(var i=[],s=0;s<t.length;s++)i[s]=t[s]-e[s];return i},vectorAdd:function(t,e){for(var i=[],s=0;s<t.length;s++)i[s]=t[s]+e[s];return i},vectorMult:function(t,e){for(var i=[],s=0;s<t.length;s++)i[s]=t[s]*e;return i},vectorLength:function(t){for(var e=0,i=0;i<t.length;i++)e+=t[i]*t[i];return Math.sqrt(e)}},h.arrayToRgb=function(t){for(var e,i="#",s=0;s<t.length;s++)i+=1==(e=t[s].toString(16)).length?"0"+e:e;return i},h.rgbToArray=function(t){return"string"==typeof t?(t=t.substr(1),[parseInt(t.substr(0,2),16),parseInt(t.substr(2,2),16),parseInt(t.substr(4,2),16)]):t}}();